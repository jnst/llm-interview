---
title: 適応型ソフトマックス
contexts:
  - optimization
  - math
---

<Context name="optimization">

## 適応型ソフトマックス

適応型ソフトマックス（Adaptive Softmax）は、大規模な語彙を持つ言語モデルにおいて、出力層の計算効率を大幅に改善する最適化手法です。従来のソフトマックスでは語彙サイズに比例して計算量が増加する問題を、語彙の頻度に基づく階層的な構造で解決します。

### 従来のソフトマックスの問題点

**計算量の課題**
- 語彙サイズが10万語の場合、各予測で10万回の内積計算が必要
- メモリ使用量も語彙サイズに比例して増加
- 学習時間の大幅な増加

**実用性の限界**
- 大規模言語モデルでは語彙サイズが数万から数十万に達する
- リアルタイム推論での応答速度の問題

### 適応型ソフトマックスの仕組み

**階層的クラスタリング**
1. 語彙を頻度に基づいて複数のクラスタに分割
2. 高頻度語彙：小さなクラスタで高精度
3. 低頻度語彙：大きなクラスタで効率性重視

**計算プロセス**
1. まず、どのクラスタに属するかを予測
2. 次に、選択されたクラスタ内で具体的な単語を予測
3. 全体の確率は条件付き確率の積として計算

### 最適化効果

**計算量の削減**
- O(V) → O(√V) の計算量削減（Vは語彙サイズ）
- 実際の実装では2-5倍の高速化を実現

**メモリ効率**
- 埋め込み行列のサイズ削減
- 動的な重み割り当てによるメモリ使用量最適化

**精度の維持**
- 頻度の高い重要な語彙では精度を保持
- 全体的な性能劣化を最小限に抑制

### 他の最適化手法との比較

**階層的ソフトマックス**
- 二分木構造を使用
- 適応型ソフトマックスの方が実用的な性能

**負例サンプリング**
- 学習時の計算量削減に特化
- 適応型ソフトマックスは推論時も効率的

### 実装上の考慮点

**クラスタリング戦略**
- 語彙頻度の分析とクラスタ境界の決定
- 動的なクラスタ再編成の必要性

**ハイパーパラメータ調整**
- クラスタ数の最適化
- 各クラスタのサイズバランス

**学習安定性**
- 勾配の流れの確保
- 学習率の調整

</Context>

<Context name="math">

## 適応型ソフトマックス

適応型ソフトマックス（Adaptive Softmax）は、大規模語彙における確率分布計算の数学的効率化手法です。従来のソフトマックス関数の計算複雑性を、語彙の統計的性質を利用した階層的確率モデルで解決します。

### 数学的定義と原理

**従来のソフトマックス**
```
P(w_i|x) = exp(h^T v_i) / Σ_j exp(h^T v_j)
```
- h: 隠れ状態ベクトル
- v_i: 単語iの出力埋め込み
- 分母の正規化項がO(V)の計算量

**適応型ソフトマックスの確率分解**
```
P(w|x) = P(c|x) × P(w|c,x)
```
- c: 単語wが属するクラスタ
- 条件付き確率による分解

### 階層的確率モデルの構築

**クラスタ確率の計算**
```
P(c_k|x) = exp(h^T u_k) / Σ_j exp(h^T u_j)
```
- u_k: クラスタkの代表ベクトル
- クラスタ数K << 語彙サイズV

**クラスタ内確率の計算**
```
P(w_i|c_k,x) = exp(h^T v_{i,k}) / Σ_{j∈c_k} exp(h^T v_{j,k})
```
- v_{i,k}: クラスタk内での単語iの埋め込み

### 数学的最適化の効果

**計算複雑性の改善**
- 従来: O(V) → 適応型: O(K + V_max)
- V_max: 最大クラスタサイズ
- 最適分割時: O(√V)

**期待値による計算量分析**
```
E[計算量] = Σ_k P(c_k) × |c_k|
```
- 頻度の高いクラスタを小さくすることで期待値を最小化

### 統計的性質の活用

**Zipf分布の利用**
- 自然言語の語彙頻度はZipf分布に従う
- 少数の単語が大部分の出現を占める性質を活用

**情報理論的解釈**
- 頻度に基づく符号化の原理
- 高頻度語彙に短い符号（小さなクラスタ）を割り当て

### 数値安定性と実装

**オーバーフロー対策**
```
log P(w|x) = log P(c|x) + log P(w|c,x)
```
- 対数空間での計算により数値安定性を確保

**勾配計算の効率化**
- 選択されたクラスタのみの勾配計算
- 疎な勾配更新による高速化

**近似誤差の制御**
- クラスタ分割による近似誤差の定量化
- 理論的な誤差境界の導出

数学的観点から、適応型ソフトマックスは確率論、情報理論、計算複雑性理論の融合により、実用的な効率化を実現した手法です。

</Context>

